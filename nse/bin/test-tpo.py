# -*- coding: utf-8 -*-
"""
Created on Tue Oct 10 14:38:02 2017

@author: abhishek.chaturvedi
"""

import urllib, time
import pandas as pd
from datetime import date
from datetime import datetime as dt
import datetime
from prettytable import PrettyTable, from_csv  # for publishing data

# global variables
ticks = []  # stores IB data raw
dates = []  # columns of our output
prices = []  # rows of our output
table = []  # final output table
today = dt.today()  # current date and time reference
now = dt.now()  # current date and time reference
ts = now.strftime('%Y%m%d') + ' ' + now.strftime('%X') + ' PST'  # convert current time into IB friendly format
date_format = '%Y-%m-%d-%X'
print 'TS=',ts
tick ='MARUTI'
directory = '/Users/abhishek.chaturvedi/PycharmProjects/self/test/data'
filename='%s/%s_1min.csv' % (directory,tick)
precision = 2.

ticks = []
dates = []
prices = []
table = []
#utc = dt.datetime.strptime('%s' % inListitem, date_format)
#epoch = (utc - dt.datetime(1970, 1, 1)).total_seconds()

column_names = [tick,'day','time','open','high','low','close','volume']
#df = pd.read_csv(filename, names=column_names)
#df['period'] = df.day.map(str) + '-' + df.time
#df['epoch'] = (dt.strptime(df.period, date_format) - dt(1970,1,1)).total_seconds()

#print df.tail(20)
print 'Pulled: ', tick, 'stock'

###
# functions
# define a dictionary of codes for time periods for market profile
coderef_us = {
    '06:30:00': 'A',
    '06:31:00': 'A',
    '06:32:00': 'A',
    '06:33:00': 'A',
    '06:34:00': 'A',
    '06:35:00': 'A',
    '06:36:00': 'A',
    '06:37:00': 'A',
    '06:38:00': 'A',
    '06:39:00': 'A',
    '06:40:00': 'A',
    '06:41:00': 'A',
    '06:42:00': 'A',
    '06:43:00': 'A',
    '06:44:00': 'A',
    '06:45:00': 'A',
    '06:46:00': 'A',
    '06:47:00': 'A',
    '06:48:00': 'A',
    '06:49:00': 'A',
    '06:50:00': 'A',
    '06:51:00': 'A',
    '06:52:00': 'A',
    '06:53:00': 'A',
    '06:54:00': 'A',
    '06:55:00': 'A',
    '06:56:00': 'A',
    '06:57:00': 'A',
    '06:58:00': 'A',
    '06:59:00': 'A',
    '07:00:00': 'B',
    '07:01:00': 'B',
    '07:02:00': 'B',
    '07:03:00': 'B',
    '07:04:00': 'B',
    '07:05:00': 'B',
    '07:06:00': 'B',
    '07:07:00': 'B',
    '07:08:00': 'B',
    '07:09:00': 'B',
    '07:10:00': 'B',
    '07:11:00': 'B',
    '07:12:00': 'B',
    '07:13:00': 'B',
    '07:14:00': 'B',
    '07:15:00': 'B',
    '07:16:00': 'B',
    '07:17:00': 'B',
    '07:18:00': 'B',
    '07:19:00': 'B',
    '07:20:00': 'B',
    '07:21:00': 'B',
    '07:22:00': 'B',
    '07:23:00': 'B',
    '07:24:00': 'B',
    '07:25:00': 'B',
    '07:26:00': 'B',
    '07:27:00': 'B',
    '07:28:00': 'B',
    '07:29:00': 'B',
    '07:30:00': 'C',
    '07:31:00': 'C',
    '07:32:00': 'C',
    '07:33:00': 'C',
    '07:34:00': 'C',
    '07:35:00': 'C',
    '07:36:00': 'C',
    '07:37:00': 'C',
    '07:38:00': 'C',
    '07:39:00': 'C',
    '07:40:00': 'C',
    '07:41:00': 'C',
    '07:42:00': 'C',
    '07:43:00': 'C',
    '07:44:00': 'C',
    '07:45:00': 'C',
    '07:46:00': 'C',
    '07:47:00': 'C',
    '07:48:00': 'C',
    '07:49:00': 'C',
    '07:50:00': 'C',
    '07:51:00': 'C',
    '07:52:00': 'C',
    '07:53:00': 'C',
    '07:54:00': 'C',
    '07:55:00': 'C',
    '07:56:00': 'C',
    '07:57:00': 'C',
    '07:58:00': 'C',
    '07:59:00': 'C',
    '08:00:00': 'D',
    '08:01:00': 'D',
    '08:02:00': 'D',
    '08:03:00': 'D',
    '08:04:00': 'D',
    '08:05:00': 'D',
    '08:06:00': 'D',
    '08:07:00': 'D',
    '08:08:00': 'D',
    '08:09:00': 'D',
    '08:10:00': 'D',
    '08:11:00': 'D',
    '08:12:00': 'D',
    '08:13:00': 'D',
    '08:14:00': 'D',
    '08:15:00': 'D',
    '08:16:00': 'D',
    '08:17:00': 'D',
    '08:18:00': 'D',
    '08:19:00': 'D',
    '08:20:00': 'D',
    '08:21:00': 'D',
    '08:22:00': 'D',
    '08:23:00': 'D',
    '08:24:00': 'D',
    '08:25:00': 'D',
    '08:26:00': 'D',
    '08:27:00': 'D',
    '08:28:00': 'D',
    '08:29:00': 'D',
    '08:30:00': 'E',
    '08:31:00': 'E',
    '08:32:00': 'E',
    '08:33:00': 'E',
    '08:34:00': 'E',
    '08:35:00': 'E',
    '08:36:00': 'E',
    '08:37:00': 'E',
    '08:38:00': 'E',
    '08:39:00': 'E',
    '08:40:00': 'E',
    '08:41:00': 'E',
    '08:42:00': 'E',
    '08:43:00': 'E',
    '08:44:00': 'E',
    '08:45:00': 'E',
    '08:46:00': 'E',
    '08:47:00': 'E',
    '08:48:00': 'E',
    '08:49:00': 'E',
    '08:50:00': 'E',
    '08:51:00': 'E',
    '08:52:00': 'E',
    '08:53:00': 'E',
    '08:54:00': 'E',
    '08:55:00': 'E',
    '08:56:00': 'E',
    '08:57:00': 'E',
    '08:58:00': 'E',
    '08:59:00': 'E',
    '09:00:00': 'F',
    '09:01:00': 'F',
    '09:02:00': 'F',
    '09:03:00': 'F',
    '09:04:00': 'F',
    '09:05:00': 'F',
    '09:06:00': 'F',
    '09:07:00': 'F',
    '09:08:00': 'F',
    '09:09:00': 'F',
    '09:10:00': 'F',
    '09:11:00': 'F',
    '09:12:00': 'F',
    '09:13:00': 'F',
    '09:14:00': 'F',
    '09:15:00': 'F',
    '09:16:00': 'F',
    '09:17:00': 'F',
    '09:18:00': 'F',
    '09:19:00': 'F',
    '09:20:00': 'F',
    '09:21:00': 'F',
    '09:22:00': 'F',
    '09:23:00': 'F',
    '09:24:00': 'F',
    '09:25:00': 'F',
    '09:26:00': 'F',
    '09:27:00': 'F',
    '09:28:00': 'F',
    '09:29:00': 'F',
    '09:30:00': 'G',
    '09:31:00': 'G',
    '09:32:00': 'G',
    '09:33:00': 'G',
    '09:34:00': 'G',
    '09:35:00': 'G',
    '09:36:00': 'G',
    '09:37:00': 'G',
    '09:38:00': 'G',
    '09:39:00': 'G',
    '09:40:00': 'G',
    '09:41:00': 'G',
    '09:42:00': 'G',
    '09:43:00': 'G',
    '09:44:00': 'G',
    '09:45:00': 'G',
    '09:46:00': 'G',
    '09:47:00': 'G',
    '09:48:00': 'G',
    '09:49:00': 'G',
    '09:50:00': 'G',
    '09:51:00': 'G',
    '09:52:00': 'G',
    '09:53:00': 'G',
    '09:54:00': 'G',
    '09:55:00': 'G',
    '09:56:00': 'G',
    '09:57:00': 'G',
    '09:58:00': 'G',
    '09:59:00': 'G',
    '10:00:00': 'H',
    '10:01:00': 'H',
    '10:02:00': 'H',
    '10:03:00': 'H',
    '10:04:00': 'H',
    '10:05:00': 'H',
    '10:06:00': 'H',
    '10:07:00': 'H',
    '10:08:00': 'H',
    '10:09:00': 'H',
    '10:10:00': 'H',
    '10:11:00': 'H',
    '10:12:00': 'H',
    '10:13:00': 'H',
    '10:14:00': 'H',
    '10:15:00': 'H',
    '10:16:00': 'H',
    '10:17:00': 'H',
    '10:18:00': 'H',
    '10:19:00': 'H',
    '10:20:00': 'H',
    '10:21:00': 'H',
    '10:22:00': 'H',
    '10:23:00': 'H',
    '10:24:00': 'H',
    '10:25:00': 'H',
    '10:26:00': 'H',
    '10:27:00': 'H',
    '10:28:00': 'H',
    '10:29:00': 'H',
    '10:30:00': 'I',
    '10:31:00': 'I',
    '10:32:00': 'I',
    '10:33:00': 'I',
    '10:34:00': 'I',
    '10:35:00': 'I',
    '10:36:00': 'I',
    '10:37:00': 'I',
    '10:38:00': 'I',
    '10:39:00': 'I',
    '10:40:00': 'I',
    '10:41:00': 'I',
    '10:42:00': 'I',
    '10:43:00': 'I',
    '10:44:00': 'I',
    '10:45:00': 'I',
    '10:46:00': 'I',
    '10:47:00': 'I',
    '10:48:00': 'I',
    '10:49:00': 'I',
    '10:50:00': 'I',
    '10:51:00': 'I',
    '10:52:00': 'I',
    '10:53:00': 'I',
    '10:54:00': 'I',
    '10:55:00': 'I',
    '10:56:00': 'I',
    '10:57:00': 'I',
    '10:58:00': 'I',
    '10:59:00': 'I',
    '11:00:00': 'J',
    '11:01:00': 'J',
    '11:02:00': 'J',
    '11:03:00': 'J',
    '11:04:00': 'J',
    '11:05:00': 'J',
    '11:06:00': 'J',
    '11:07:00': 'J',
    '11:08:00': 'J',
    '11:09:00': 'J',
    '11:10:00': 'J',
    '11:11:00': 'J',
    '11:12:00': 'J',
    '11:13:00': 'J',
    '11:14:00': 'J',
    '11:15:00': 'J',
    '11:16:00': 'J',
    '11:17:00': 'J',
    '11:18:00': 'J',
    '11:19:00': 'J',
    '11:20:00': 'J',
    '11:21:00': 'J',
    '11:22:00': 'J',
    '11:23:00': 'J',
    '11:24:00': 'J',
    '11:25:00': 'J',
    '11:26:00': 'J',
    '11:27:00': 'J',
    '11:28:00': 'J',
    '11:29:00': 'J',
    '11:30:00': 'K',
    '11:31:00': 'K',
    '11:32:00': 'K',
    '11:33:00': 'K',
    '11:34:00': 'K',
    '11:35:00': 'K',
    '11:36:00': 'K',
    '11:37:00': 'K',
    '11:38:00': 'K',
    '11:39:00': 'K',
    '11:40:00': 'K',
    '11:41:00': 'K',
    '11:42:00': 'K',
    '11:43:00': 'K',
    '11:44:00': 'K',
    '11:45:00': 'K',
    '11:46:00': 'K',
    '11:47:00': 'K',
    '11:48:00': 'K',
    '11:49:00': 'K',
    '11:50:00': 'K',
    '11:51:00': 'K',
    '11:52:00': 'K',
    '11:53:00': 'K',
    '11:54:00': 'K',
    '11:55:00': 'K',
    '11:56:00': 'K',
    '11:57:00': 'K',
    '11:58:00': 'K',
    '11:59:00': 'K',
    '12:00:00': 'L',
    '12:01:00': 'L',
    '12:02:00': 'L',
    '12:03:00': 'L',
    '12:04:00': 'L',
    '12:05:00': 'L',
    '12:06:00': 'L',
    '12:07:00': 'L',
    '12:08:00': 'L',
    '12:09:00': 'L',
    '12:10:00': 'L',
    '12:11:00': 'L',
    '12:12:00': 'L',
    '12:13:00': 'L',
    '12:14:00': 'L',
    '12:15:00': 'L',
    '12:16:00': 'L',
    '12:17:00': 'L',
    '12:18:00': 'L',
    '12:19:00': 'L',
    '12:20:00': 'L',
    '12:21:00': 'L',
    '12:22:00': 'L',
    '12:23:00': 'L',
    '12:24:00': 'L',
    '12:25:00': 'L',
    '12:26:00': 'L',
    '12:27:00': 'L',
    '12:28:00': 'L',
    '12:29:00': 'L',
    '12:30:00': 'M',
    '12:31:00': 'M',
    '12:32:00': 'M',
    '12:33:00': 'M',
    '12:34:00': 'M',
    '12:35:00': 'M',
    '12:36:00': 'M',
    '12:37:00': 'M',
    '12:38:00': 'M',
    '12:39:00': 'M',
    '12:40:00': 'M',
    '12:41:00': 'M',
    '12:42:00': 'M',
    '12:43:00': 'M',
    '12:44:00': 'M',
    '12:45:00': 'M',
    '12:46:00': 'M',
    '12:47:00': 'M',
    '12:48:00': 'M',
    '12:49:00': 'M',
    '12:50:00': 'M',
    '12:51:00': 'M',
    '12:52:00': 'M',
    '12:53:00': 'M',
    '12:54:00': 'M',
    '12:55:00': 'M',
    '12:56:00': 'M',
    '12:57:00': 'M',
    '12:58:00': 'M',
    '12:59:00': 'M'
}

coderef = {
    '9:15:00': 'A',
    '9:30:00': 'A',
    '9:45:00': 'B',
    '10:00:00': 'B',
    '10:15:00': 'C',
    '10:30:00': 'C',
    '10:45:00': 'D',
    '11:00:00': 'D',
    '11:15:00': 'E',
    '11:30:00': 'E',
    '11:45:00': 'F',
    '12:00:00': 'F',
    '12:15:00': 'G',
    '12:30:00': 'G',
    '12:45:00': 'H',
    '13:00:00': 'H',
    '13:15:00': 'I',
    '13:30:00': 'I',
    '13:45:00': 'J',
    '14:00:00': 'J',
    '14:15:00': 'K',
    '14:30:00': 'K',
    '14:45:00': 'L',
    '15:00:00': 'L',
    '15:15:00': 'M',
    '15:30:00': 'M'
}

coderef_in_1min = {
        '09:16:00': 'A',
        '09:17:00': 'A',
        '09:18:00': 'A',
        '09:19:00': 'A',
        '09:20:00': 'A',
        '09:21:00': 'A',
        '09:22:00': 'A',
        '09:23:00': 'A',
        '09:24:00': 'A',
        '09:25:00': 'A',
        '09:26:00': 'A',
        '09:27:00': 'A',
        '09:28:00': 'A',
        '09:29:00': 'A',
        '09:30:00': 'A',
        '09:31:00': 'B',
        '09:32:00': 'B',
        '09:33:00': 'B',
        '09:34:00': 'B',
        '09:35:00': 'B',
        '09:36:00': 'B',
        '09:37:00': 'B',
        '09:38:00': 'B',
        '09:39:00': 'B',
        '09:40:00': 'B',
        '09:41:00': 'B',
        '09:42:00': 'B',
        '09:43:00': 'B',
        '09:44:00': 'B',
        '09:45:00': 'B',
        '09:46:00': 'B',
        '09:47:00': 'B',
        '09:48:00': 'B',
        '09:49:00': 'B',
        '09:50:00': 'B',
        '09:51:00': 'B',
        '09:52:00': 'B',
        '09:53:00': 'B',
        '09:54:00': 'B',
        '09:55:00': 'B',
        '09:56:00': 'B',
        '09:57:00': 'B',
        '09:58:00': 'B',
        '09:59:00': 'B',
        '10:00:00': 'C',
        '10:01:00': 'C',
        '10:02:00': 'C',
        '10:03:00': 'C',
        '10:04:00': 'C',
        '10:05:00': 'C',
        '10:06:00': 'C',
        '10:07:00': 'C',
        '10:08:00': 'C',
        '10:09:00': 'C',
        '10:10:00': 'C',
        '10:11:00': 'C',
        '10:12:00': 'C',
        '10:13:00': 'C',
        '10:14:00': 'C',
        '10:15:00': 'C',
        '10:16:00': 'C',
        '10:17:00': 'C',
        '10:18:00': 'C',
        '10:19:00': 'C',
        '10:20:00': 'C',
        '10:21:00': 'C',
        '10:22:00': 'C',
        '10:23:00': 'C',
        '10:24:00': 'C',
        '10:25:00': 'C',
        '10:26:00': 'C',
        '10:27:00': 'C',
        '10:28:00': 'C',
        '10:29:00': 'C',
        '10:30:00': 'D',
        '10:31:00': 'D',
        '10:32:00': 'D',
        '10:33:00': 'D',
        '10:34:00': 'D',
        '10:35:00': 'D',
        '10:36:00': 'D',
        '10:37:00': 'D',
        '10:38:00': 'D',
        '10:39:00': 'D',
        '10:40:00': 'D',
        '10:41:00': 'D',
        '10:42:00': 'D',
        '10:43:00': 'D',
        '10:44:00': 'D',
        '10:45:00': 'D',
        '10:46:00': 'D',
        '10:47:00': 'D',
        '10:48:00': 'D',
        '10:49:00': 'D',
        '10:50:00': 'D',
        '10:51:00': 'D',
        '10:52:00': 'D',
        '10:53:00': 'D',
        '10:54:00': 'D',
        '10:55:00': 'D',
        '10:56:00': 'D',
        '10:57:00': 'D',
        '10:58:00': 'D',
        '10:59:00': 'D',
        '11:00:00': 'E',
        '11:01:00': 'E',
        '11:02:00': 'E',
        '11:03:00': 'E',
        '11:04:00': 'E',
        '11:05:00': 'E',
        '11:06:00': 'E',
        '11:07:00': 'E',
        '11:08:00': 'E',
        '11:09:00': 'E',
        '11:10:00': 'E',
        '11:11:00': 'E',
        '11:12:00': 'E',
        '11:13:00': 'E',
        '11:14:00': 'E',
        '11:15:00': 'E',
        '11:16:00': 'E',
        '11:17:00': 'E',
        '11:18:00': 'E',
        '11:19:00': 'E',
        '11:20:00': 'E',
        '11:21:00': 'E',
        '11:22:00': 'E',
        '11:23:00': 'E',
        '11:24:00': 'E',
        '11:25:00': 'E',
        '11:26:00': 'E',
        '11:27:00': 'E',
        '11:28:00': 'E',
        '11:29:00': 'E',
        '11:30:00': 'F',
        '11:31:00': 'F',
        '11:32:00': 'F',
        '11:33:00': 'F',
        '11:34:00': 'F',
        '11:35:00': 'F',
        '11:36:00': 'F',
        '11:37:00': 'F',
        '11:38:00': 'F',
        '11:39:00': 'F',
        '11:40:00': 'F',
        '11:41:00': 'F',
        '11:42:00': 'F',
        '11:43:00': 'F',
        '11:44:00': 'F',
        '11:45:00': 'F',
        '11:46:00': 'F',
        '11:47:00': 'F',
        '11:48:00': 'F',
        '11:49:00': 'F',
        '11:50:00': 'F',
        '11:51:00': 'F',
        '11:52:00': 'F',
        '11:53:00': 'F',
        '11:54:00': 'F',
        '11:55:00': 'F',
        '11:56:00': 'F',
        '11:57:00': 'F',
        '11:58:00': 'F',
        '11:59:00': 'F',
        '12:00:00': 'G',
        '12:01:00': 'G',
        '12:02:00': 'G',
        '12:03:00': 'G',
        '12:04:00': 'G',
        '12:05:00': 'G',
        '12:06:00': 'G',
        '12:07:00': 'G',
        '12:08:00': 'G',
        '12:09:00': 'G',
        '12:10:00': 'G',
        '12:11:00': 'G',
        '12:12:00': 'G',
        '12:13:00': 'G',
        '12:14:00': 'G',
        '12:15:00': 'G',
        '12:16:00': 'G',
        '12:17:00': 'G',
        '12:18:00': 'G',
        '12:19:00': 'G',
        '12:20:00': 'G',
        '12:21:00': 'G',
        '12:22:00': 'G',
        '12:23:00': 'G',
        '12:24:00': 'G',
        '12:25:00': 'G',
        '12:26:00': 'G',
        '12:27:00': 'G',
        '12:28:00': 'G',
        '12:29:00': 'G',
        '12:30:00': 'H',
        '12:31:00': 'H',
        '12:32:00': 'H',
        '12:33:00': 'H',
        '12:34:00': 'H',
        '12:35:00': 'H',
        '12:36:00': 'H',
        '12:37:00': 'H',
        '12:38:00': 'H',
        '12:39:00': 'H',
        '12:40:00': 'H',
        '12:41:00': 'H',
        '12:42:00': 'H',
        '12:43:00': 'H',
        '12:44:00': 'H',
        '12:45:00': 'H',
        '12:46:00': 'H',
        '12:47:00': 'H',
        '12:48:00': 'H',
        '12:49:00': 'H',
        '12:50:00': 'H',
        '12:51:00': 'H',
        '12:52:00': 'H',
        '12:53:00': 'H',
        '12:54:00': 'H',
        '12:55:00': 'H',
        '12:56:00': 'H',
        '12:57:00': 'H',
        '12:58:00': 'H',
        '12:59:00': 'H',
        '13:00:00': 'I',
        '13:01:00': 'I',
        '13:02:00': 'I',
        '13:03:00': 'I',
        '13:04:00': 'I',
        '13:05:00': 'I',
        '13:06:00': 'I',
        '13:07:00': 'I',
        '13:08:00': 'I',
        '13:09:00': 'I',
        '13:10:00': 'I',
        '13:11:00': 'I',
        '13:12:00': 'I',
        '13:13:00': 'I',
        '13:14:00': 'I',
        '13:15:00': 'I',
        '13:16:00': 'I',
        '13:17:00': 'I',
        '13:18:00': 'I',
        '13:19:00': 'I',
        '13:20:00': 'I',
        '13:21:00': 'I',
        '13:22:00': 'I',
        '13:23:00': 'I',
        '13:24:00': 'I',
        '13:25:00': 'I',
        '13:26:00': 'I',
        '13:27:00': 'I',
        '13:28:00': 'I',
        '13:29:00': 'I',
        '13:30:00': 'J',
        '13:31:00': 'J',
        '13:32:00': 'J',
        '13:33:00': 'J',
        '13:34:00': 'J',
        '13:35:00': 'J',
        '13:36:00': 'J',
        '13:37:00': 'J',
        '13:38:00': 'J',
        '13:39:00': 'J',
        '13:40:00': 'J',
        '13:41:00': 'J',
        '13:42:00': 'J',
        '13:43:00': 'J',
        '13:44:00': 'J',
        '13:45:00': 'J',
        '13:46:00': 'J',
        '13:47:00': 'J',
        '13:48:00': 'J',
        '13:49:00': 'J',
        '13:50:00': 'J',
        '13:51:00': 'J',
        '13:52:00': 'J',
        '13:53:00': 'J',
        '13:54:00': 'J',
        '13:55:00': 'J',
        '13:56:00': 'J',
        '13:57:00': 'J',
        '13:58:00': 'J',
        '13:59:00': 'J',
        '14:00:00': 'K',
        '14:01:00': 'K',
        '14:02:00': 'K',
        '14:03:00': 'K',
        '14:04:00': 'K',
        '14:05:00': 'K',
        '14:06:00': 'K',
        '14:07:00': 'K',
        '14:08:00': 'K',
        '14:09:00': 'K',
        '14:10:00': 'K',
        '14:11:00': 'K',
        '14:12:00': 'K',
        '14:13:00': 'K',
        '14:14:00': 'K',
        '14:15:00': 'K',
        '14:16:00': 'K',
        '14:17:00': 'K',
        '14:18:00': 'K',
        '14:19:00': 'K',
        '14:20:00': 'K',
        '14:21:00': 'K',
        '14:22:00': 'K',
        '14:23:00': 'K',
        '14:24:00': 'K',
        '14:25:00': 'K',
        '14:26:00': 'K',
        '14:27:00': 'K',
        '14:28:00': 'K',
        '14:29:00': 'K',
        '14:30:00': 'L',
        '14:31:00': 'L',
        '14:32:00': 'L',
        '14:33:00': 'L',
        '14:34:00': 'L',
        '14:35:00': 'L',
        '14:36:00': 'L',
        '14:37:00': 'L',
        '14:38:00': 'L',
        '14:39:00': 'L',
        '14:40:00': 'L',
        '14:41:00': 'L',
        '14:42:00': 'L',
        '14:43:00': 'L',
        '14:44:00': 'L',
        '14:45:00': 'L',
        '14:46:00': 'L',
        '14:47:00': 'L',
        '14:48:00': 'L',
        '14:49:00': 'L',
        '14:50:00': 'L',
        '14:51:00': 'L',
        '14:52:00': 'L',
        '14:53:00': 'L',
        '14:54:00': 'L',
        '14:55:00': 'L',
        '14:56:00': 'L',
        '14:57:00': 'L',
        '14:58:00': 'L',
        '14:59:00': 'L',
        '15:00:00': 'M',
        '15:01:00': 'M',
        '15:02:00': 'M',
        '15:03:00': 'M',
        '15:04:00': 'M',
        '15:05:00': 'M',
        '15:06:00': 'M',
        '15:07:00': 'M',
        '15:08:00': 'M',
        '15:09:00': 'M',
        '15:10:00': 'M',
        '15:11:00': 'M',
        '15:12:00': 'M',
        '15:13:00': 'M',
        '15:14:00': 'M',
        '15:15:00': 'M',
        '15:16:00': 'M',
        '15:17:00': 'M',
        '15:18:00': 'M',
        '15:19:00': 'M',
        '15:20:00': 'M',
        '15:21:00': 'M',
        '15:22:00': 'M',
        '15:23:00': 'M',
        '15:24:00': 'M',
        '15:25:00': 'M',
        '15:26:00': 'M',
        '15:27:00': 'M',
        '15:28:00': 'M',
        '15:29:00': 'M',
        '15:30:00': 'N'
}

def code(datetimestamp):
    # use the timestamp of each tick data and assign a code by looking up our reference
    return coderef_in_1min.get(datetimestamp, '-')


def formatdata(ticks, prices, dates, table):
    tpos = sorted(set(ticks), reverse=True)
    # print(tpos)
    levels = sorted(set(prices), reverse=True)
    periods = sorted(set(dates))

    lowprice = float(levels[0])
    print lowprice
    #startdate = int(periods[0])
    #highprice = float(levels[-1])
    #enddate = int(periods[-1])
    days = len(periods)
    points = len(levels)

    # checks
    # print(lowprice, startdate, highprice, enddate, days, points)
    # print(periods, levels)

    # initialize table with null elements
    p = 0
    while p <= points:
        d = 0
        # setup row first line)
        if p == 0:
            trow = ['Price/Date']
        else:
            trow = [levels[p - 1]]

        while d < days:
            if p == 0:
                trow.append(periods[d])
            else:
                trow.append('')
            d += 1
        table.append(trow)
        p += 1

    # modify table values to get TPO charts
    for t in tpos:
        ntposplit = t.split(' ')
        ntpoprice = float(ntposplit[0])  # needs to be int because of rounded prices
        ntpodate = ntposplit[1]  # this can be string
        ntpocode = ntposplit[2]
        p = levels.index(ntpoprice) + 1
        q = periods.index(ntpodate) + 1
        # check
        # print(ntpoprice, p, ntpodate, q)
        if table[p][q].count(ntpocode) <= 0:
            ecode = str(table[p][q])
            table[p][q] = ntpocode + ecode

    # add POC and VA markers on TPO charts
    for d in periods:
        maxlen = 0
        cumlen = []
        cumlen.append(0)
        vah = 0
        val = 0
        maxp = ''
        q = periods.index(d) + 1
        for l in levels:
            p = levels.index(l) + 1
            # check
            # print(ntpoprice, p, ntpodate, q)
            cumlen.append(cumlen[p - 1] + len(table[p][q]))
            if len(table[p][q]) >= maxlen:
                maxlen = len(table[p][q])
                maxp = p
        table[maxp][q] = table[maxp][q] + '*'  # + str(levels[maxp])
        for l in levels:
            p = levels.index(l) + 1
            cumlen[p] = cumlen[p] / cumlen[-1]
            if (cumlen[p] > 0.15 and vah <= 0 and table[p][q].find('<<POC>>') < 0):
                table[p][q] = table[p][q] + '<'  # + str(levels[p])
                vah += 1
            if (cumlen[p] > 0.85 and val <= 0 and table[p][q].find('<<POC>>') < 0):
                table[p][q] = table[p][q] + '<'  # + str(levels[p])
                val += 1


def writeDataToCSV(directory, tickername=None, lookback=None, interval=None):
    import csv
    with open('%s/arrays.csv' % directory, 'w') as csvfile:
        writer = csv.writer(csvfile, dialect='excel')
        writer.writerows(table)
    now = datetime.datetime.now()
    ts = now.strftime('%Y%m%d')
    fp = open("%s/arrays.csv" % directory, "r")
    pt = from_csv(fp)
    fp.close()
    pt.align = "l"
    #print(tickername + ' TPOs ' + 'for ' + ts + ' -' + lookback + ' @' + interval + ' interval.')
    print(pt)
###

try:
    readExistingData = open(filename, 'r').read()
    splitExisting = readExistingData.split('\n')
    mostRecentLine = splitExisting[-2]
    lastUnix = mostRecentLine.split(',')[0]
    print('Data File exists.')
except Exception, e:
    print str(e)
    time.sleep(5)
    lastUnix = 0
for eachLine in splitExisting:
    if eachLine:
        splitLine = eachLine.split(',')
        #Example
        #['MARUTI', '2017-07-28', '21:30:00', '7890.50', '7934.90', '7885.30', '7886.00', '224485.0']
        close = splitLine[6]
        time = splitLine[2]
        day = splitLine[1]
        ticks.append(str(float(close)) + ' ' + day + ' ' + code(time))  # ticks will hold a list of tick information we need
        dates.append(day)  # get just the date in IB format
        prices.append(float(close))  # get the prices rounded off (Need to figure this out, maybe a user input)

tpos = sorted(set(ticks), reverse=True)
#levels = sorted(set(prices), reverse=True)
#periods = sorted(set(dates))
formatdata(ticks, prices, dates, table)
print 'Table=',table

writeDataToCSV(directory, tick)

        #ticks.append(df.day)
#ticks.append(round(df.close.map(str), precision) + ' ' + datestamp(df.time.map(str)) + ' ' + code(df.time.map(str)))  # ticks will hold a list of tick information we need
#dates.append(datestamp(df.time))  # get just the date in IB format
#prices.append(round(df.close, precision))  # get the prices rounded off (Need to figure this out, maybe a user input)

#print ticks